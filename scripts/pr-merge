#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "$0")" && pwd)"
base="$script_dir/pr"
if common_git_dir=$(git -C "$script_dir" rev-parse --path-format=absolute --git-common-dir 2>/dev/null); then
  canonical_base="$(dirname "$common_git_dir")/scripts/pr"
  if [ -x "$canonical_base" ]; then
    base="$canonical_base"
  fi
fi

usage() {
  cat <<USAGE
Usage:
  scripts/pr-merge <PR>                # verify only
  scripts/pr-merge verify <PR>         # verify only
  scripts/pr-merge run <PR> [--execute]
USAGE
}

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ] || [ "$#" -lt 1 ]; then
  usage
  exit $([ "$#" -lt 1 ] && echo 1 || echo 0)
fi

if [ "$#" -eq 1 ]; then
  exec "$base" merge-verify "$1"
fi

if [ "$#" -ge 2 ]; then
  mode="$1"
  pr="$2"
  shift 2 || true
  case "$mode" in
    verify)
      exec "$base" merge-verify "$pr" "$@"
      ;;
    run)
      exec "$base" merge-run "$pr" "$@"
      ;;
    *)
      usage
      exit 2
      ;;
  esac
fi

usage
exit 2
